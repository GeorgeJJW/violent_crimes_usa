library(shiny)
library(tidyverse)
library(DT)
library(leaflet)
library(htmltools)
library(rsconnect)
library(shinydashboard)
library(plotly)

data <- read_csv("data/crime_clean.csv")

ui <- dashboardPage(skin = "black",

  #tags$style("label{font-family: Open Sans;}"),
  #titlePanel("Violent Crimes in the United States (1975-2014)"),
  dashboardHeader(title = "US Violent Crime"),
  
  dashboardSidebar(
    sidebarMenu(

      #tags$style(".well {background-color:rgba(13, 160, 165, 0.15);}"),
      #tags$style(HTML("hr {border-top: 1px solid #0D9DA3; margin-top: 250px; margin-bottom: 20px;}")),

      helpText("Compare crime rates (per 100k population) of major US cities:"),

      # year input
      selectInput("year", "SELECT YEAR",
                  c("Average Over Time" = "1975-2014",
                  sort(unique(data$year), decreasing = TRUE)),
                  selectize = TRUE),

      # crimes input
      checkboxGroupInput("crime", "SELECT CRIME(S)",
                         c("Homicide" = "HOMICIDE",
                           "Rape" = "RAPE",
                           "Robbery" = "ROBBERY",
                           "Aggravated Assault" = "AGGRAVATED ASSAULT"),
                         selected = "ROBBERY"),

      # break line
      hr(),
      helpText("Graph crime trends of a specific city over time:"),

      # city selector
      selectizeInput("city", "SELECT CITY",
                  c("All Cities", unique(data$department_name)))

    )
  ),

    dashboardBody(
      tags$head(tags$style(HTML('
        .skin-black .main-header .logo {background-color: #f2f4fb;}
        .skin-black .main-header .navbar {background-color: #f2f4fb;}
        .skin-black .main-sidebar {background-color: #726a95;}
        .content-wrapper, .right-side {background-color: #ffffff;}'))),

      # title the map/table
      titlePanel(title = list(textOutput("caption"))),

      tags$div(
        style="margin-bottom:20px;",

      # create tabs
      tabsetPanel(type = "tabs",
        tabPanel("Map", leafletOutput("map")),
        tabPanel("Rank Table", dataTableOutput("table")))
      ),

      # display violent crime plot
      fluidRow(
        h4(textOutput("plot_title"), style = "margin-bottom:20px"),
        plotlyOutput("lineplot")
      )
  )
)

server <- function(input, output) {

  #interactive title
  #output$caption <- renderText({paste(input$crime, "(per capita),", input$year)})
  output$plot_title <- renderText(paste("Crime Rates Over Time for", input$city, ":"))

  # map plot
  output$map <- renderLeaflet({
    validate(need((is.null(input$crime) == FALSE), 
                  'TO VIEW THE U.S. CRIME MAP, PLEASE SELECT A CRIME.'))
    leaflet() %>%
      addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
      setView(lng = -98.58, lat = 38, zoom = 4) %>% 
      addCircleMarkers(data = data_map(), 
                       radius = ~ sqrt(COUNT) * 0.8, 
                       color = "orange",
                       label = ~ paste(sep = "", CITY, ": ", COUNT, " incidents"))
  })

  # add total crime to table if user selects all crimes
  total_crime <- reactive({
    if(length(input$crime) < 4) {
      var_select <- c("CITY", "POPULATION", input$crime, "lon", "lat")
    } else {
      var_select <- c("CITY", "POPULATION", "TOTAL CRIME", input$crime, "lon", "lat")
    }
    return(var_select)
  })

  # sum averages over time
  data_time_ave <- reactive({

    # if user selectes "Average Over Time"
    if(input$year == "1975-2014") {
      # compute average the crime rates for each city
      data_ave <- data %>%
        group_by(department_name) %>%
        summarise("HOMICIDE" = mean(homs_per_100k),
               "RAPE" = mean(rape_per_100k),
               "ROBBERY" = mean(rob_per_100k),
               "AGGRAVATED ASSAULT" = mean(agg_ass_per_100k),
               "TOTAL CRIME" = mean(violent_per_100k))

      # subset population data to join with average data
      join_data <- data %>%
        filter(year == 2014) %>%
        select(department_name, total_pop, lon, lat)

      # join data and make presentation quality
      data_edit <- left_join(join_data, data_ave, by = "department_name")
      data_edit <- data_edit %>%
        rename("CITY" = department_name,
              "POPULATION" = total_pop) %>%
        select(total_crime()) %>%
        rename("POPULATION (in 2014)" = "POPULATION") %>%
        mutate_if(is.numeric, round, 0)
    }
    # if user selects any other year
    else {
      data_edit <- data %>% 
        filter(year == input$year) %>%
        rename("CITY" = department_name,
               "POPULATION" = total_pop,
               "TOTAL CRIME" = violent_per_100k,
               "HOMICIDE" = homs_per_100k,
               "RAPE" = rape_per_100k,
               "ROBBERY" = rob_per_100k,
               "AGGRAVATED ASSAULT" = agg_ass_per_100k) %>%
        select(total_crime()) %>%
        mutate_if(is.numeric, round, 0)
    }
    
    return(data_edit)
  })
  
  # prepare map data
  data_map <- reactive({
    data_edit <- data_time_ave()
    data_edit$COUNT <- data_edit %>% 
      select(c(one_of(input$crime))) %>% 
      rowSums()
    return(data_edit)
  })

  # rank table plot
  output$table <- renderDataTable(data_time_ave() %>% 
    select(-c("lon", "lat"))
  )

  # select "All Cities"
  city_choice <- reactive ({
    # if user selects "All Cities" find average crime rate per year across all cities
    if(input$city == "All Cities") {
      data_edit <- data %>% group_by(year) %>%
        summarise(HOMICIDE = round(mean(homs_per_100k),0),
                  RAPE = round(mean(rape_per_100k),0),
                  ROBBERY = round(mean(rob_per_100k),0),
                  ASSAULT = round(mean(agg_ass_per_100k),0))

      # if user selects any other city, report that city's crime rates over time
    } else {
      data_edit <- data %>% filter(department_name == input$city) %>%
        mutate(HOMICIDE = round(homs_per_100k,0),
               RAPE = round(rape_per_100k,0),
               ROBBERY = round(rob_per_100k,0),
               ASSAULT = round(agg_ass_per_100k,0))
    }
    
    return(data_edit)
  })
  
  lineplot_edit <- reactive ({
    plot <- city_choice() %>% ggplot(aes(text = paste("(incidents per capita)"))) +
      labs(x = "YEAR", y = "CRIME RATE (per 100k population)") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
            panel.background = element_blank(), axis.line = element_line(colour = "black"))
    if("HOMICIDE"%in%input$crime) { 
      plot <- plot + geom_line(aes(year, HOMICIDE), colour = "#bf68f6") }
    if("RAPE"%in%input$crime) {
      plot <- plot + geom_line(aes(year,RAPE), colour = "#96cd39") }
    if("ROBBERY"%in%input$crime) {
      plot <- plot + geom_line(aes(year, ROBBERY), colour = "#67bac6") }
    if("AGGRAVATED ASSAULT"%in%input$crime) {
      plot <- plot + geom_line(aes(year, ASSAULT), colour = "#ffaaa5") }
  
    return(ggplotly(plot, tooltip = c("x", "y", "text")))
  })

  # crime rates over time plot
  output$lineplot <- renderPlotly({
    validate(need((is.null(input$crime) == FALSE), 
             'TO VIEW A PLOT OF CRIME RATES OVER TIME, PLEASE SELECT A CRIME.'))
    validate(need((input$city != ""), 
                  'TO VIEW A PLOT OF CRIME RATES OVER TIME, PLEASE SELECT A CITY.'))
  lineplot_edit()
  })
    

}

shinyApp(ui = ui, server = server)
